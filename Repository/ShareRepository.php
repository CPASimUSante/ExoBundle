<?php

namespace UJM\ExoBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * ShareRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ShareRepository extends EntityRepository
{
    /**
     * Allow to know if a question is shared with an user
     *
     * @access public
     *
     * @param integer $user id User
     * @param integer $question id Question
     *
     * Return array[Share]
     */
    public function getControlSharedQuestion($user, $question)
    {
        $qb = $this->createQueryBuilder('s');
        $qb->join('s.user', 'u')
            ->where($qb->expr()->in('s.question', $question))
            ->andWhere($qb->expr()->in('u.id', $user));

        return $qb->getQuery()->getResult();
    }

    /**
     * Get the shared questions in the import view of an exercise
     *
     * @access public
     *
     * @param integer $exoId id Exercise
     * @param integer $uid id User
     * @param Doectrine EntityManager $am
     *
     * Return array[Share]
     */
    public function getUserInteractionSharedImport($exoId, $uid, $em)
    {

        $questions = array();

        $dql = 'SELECT eq FROM UJM\ExoBundle\Entity\ExerciseQuestion eq WHERE eq.exercise=' . $exoId
            . ' ORDER BY eq.ordre';

        $query = $em->createQuery($dql);
        $eqs = $query->getResult();

        foreach ($eqs as $eq) {
            $questions[] = $eq->getQuestion()->getId();
        }

        $qb = $this->createQueryBuilder('s');

        $qb->join('s.question', 'q')
           ->join('s.user', 'u')
           ->where($qb->expr()->in('u.id', $uid));
        if (count($questions) > 0) {
             $qb->andWhere('q.id not in ('.implode(',', $questions).')');
        }

        return $qb->getQuery()->getResult();
    }

    /**
     * Search shared questions by category
     *
     * @access public
     *
     * @param integer $userId id User
     * @param String $whatToFind string to find
     *
     * Return array[Share]
     */
    public function findByCategoryShared($userId, $whatToFind)
    {
        $dql = 'SELECT s FROM UJM\ExoBundle\Entity\Share s JOIN s.question q JOIN q.category c
            WHERE c.value LIKE :search
            AND s.user = '.$userId.'
        ';

        $query = $this->_em->createQuery($dql)
            ->setParameter('search', "%{$whatToFind}%");

        return $query->getResult();
    }

    /**
     * Search shared questions by title
     *
     * @access public
     *
     * @param integer $userId id User
     * @param String $whatToFind string to find
     *
     * Return array[Share]
     */
    public function findByTitleShared($userId, $whatToFind)
    {
        $dql = 'SELECT s FROM UJM\ExoBundle\Entity\Share s JOIN s.question q
            WHERE q.title LIKE :search
            AND s.user = '.$userId.'
        ';

        $query = $this->_em->createQuery($dql)
            ->setParameter('search', "%{$whatToFind}%");

        return $query->getResult();
    }

    /**
     * Search shared questions by type
     *
     * @access public
     *
     * @param integer $userId id User
     * @param String $whatToFind string to find
     *
     * Return array[Share]
     */
    public function findByTypeShared($userId, $whatToFind)
    {
        $dql = 'SELECT s FROM UJM\ExoBundle\Entity\Share s, UJM\ExoBundle\Entity\Interaction i
                WHERE s.question = i.question
                AND s.user = '.$userId.'
                AND i.type LIKE :search
        ';

        $query = $this->_em->createQuery($dql)
            ->setParameter('search', "%{$whatToFind}%");

        return $query->getResult();
    }

    /**
     * Search shared questions by contain
     *
     * @access public
     *
     * @param integer $userId id User
     * @param String $whatToFind string to find
     *
     * Return array[Share]
     */
    public function findByContainShared($userId, $whatToFind)
    {
         $dql = 'SELECT s FROM UJM\ExoBundle\Entity\Share s, UJM\ExoBundle\Entity\Interaction i
                WHERE s.question = i.question
                AND s.user = '.$userId.'
                AND i.invite LIKE :search
        ';

        $query = $this->_em->createQuery($dql)
            ->setParameter('search', "%{$whatToFind}%");

        return $query->getResult();
    }

    /**
     * Search shared questions
     *
     * @access public
     *
     * @param integer $userId id User
     * @param String $whatToFind string to find
     *
     * Return array[Share]
     */
    public function findByAllShared($userId, $whatToFind)
    {
        $dql = 'SELECT s FROM UJM\ExoBundle\Entity\Share s, UJM\ExoBundle\Entity\Interaction i,
                UJM\ExoBundle\Entity\Question q, UJM\ExoBundle\Entity\Category c
                WHERE s.question = i.question AND i.question = q AND q.category = c
                AND s.user = '.$userId.'
                AND (i.invite LIKE :search OR i.type LIKE :search OR c.value LIKE :search OR q.title LIKE :search)
        ';

        $query = $this->_em->createQuery($dql)
            ->setParameter('search', "%{$whatToFind}%");

        return $query->getResult();
    }
}